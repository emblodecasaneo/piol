// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// Énumération pour les types d'utilisateurs
enum UserType {
  TENANT
  AGENT
  ADMIN
}

// Énumération pour les types de propriétés
enum PropertyType {
  STUDIO
  CHAMBRE
  APPARTEMENT
  MAISON
  DUPLEX
}

// Énumération pour le statut de vérification
enum VerificationStatus {
  PENDING
  APPROVED
  REJECTED
}

// Énumération pour le statut des propriétés
enum PropertyStatus {
  ACTIVE
  RENTED
  INACTIVE
}

// Énumération pour les plans d'abonnement
enum SubscriptionPlan {
  FREE
  BASIC
  PREMIUM
}

// Énumération pour les statuts de rendez-vous
enum AppointmentStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

// Modèle Utilisateur
model User {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  email     String   @unique
  phone     String   @unique
  password  String
  firstName String
  lastName  String
  avatar    String?
  preferences Json?
  userType  UserType
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  agent         Agent?
  favorites     Favorite[]
  reviews       Review[]
  sentMessages  Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")
  searches      SavedSearch[]
  requestedAppointments Appointment[] @relation("RequestedAppointments")
  payments      Payment[] @relation("UserPayments")

  @@map("users")
}

// Modèle Agent Immobilier
model Agent {
  id                 String             @id @default(auto()) @map("_id") @db.ObjectId
  userId             String             @unique @db.ObjectId
  businessName       String
  license            String?
  idCardNumber       String
  
  // Documents
  idCardPhoto        String?
  profilePhoto       String?
  businessLicense    String? // Licence professionnelle
  locationPlan       String? // Plan de localisation
  proofOfAddress     String? // Justificatif de domicile
  businessCertificate String? // Certificat d'entreprise
  
  // Statuts de vérification des documents
  documentsStatus    Json? // Statut de chaque document {cni: 'verified', businessLicense: 'pending', etc.}
  rejectionReason    String? // Raison du rejet si applicable
  
  isVerified         Boolean            @default(false)
  verificationStatus VerificationStatus @default(PENDING)
  rating             Float              @default(0)
  reviewCount        Int                @default(0)
  subscriptionPlan   SubscriptionPlan   @default(FREE)
  subscriptionExpiry DateTime?
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  // Relations
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  properties        Property[]
  reviews           Review[]
  appointments      Appointment[]
  activeSubscription ActiveSubscription?

  @@map("agents")
}

// Modèle Ville
model City {
  id         String     @id @default(auto()) @map("_id") @db.ObjectId
  name       String     @unique
  region     String // Région administrative
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  // Relations
  neighborhoods Neighborhood[]
  properties    Property[]

  @@map("cities")
}

// Modèle Quartier
model Neighborhood {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  name       String
  cityId     String   @db.ObjectId
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  city       City       @relation(fields: [cityId], references: [id], onDelete: Cascade)
  localities Locality[]
  properties Property[]
  score      NeighborhoodScore?

  @@unique([name, cityId])
  @@map("neighborhoods")
}

// Modèle Score de Quartier
model NeighborhoodScore {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  neighborhoodId  String   @unique @db.ObjectId
  
  // Scores individuels (sur 5)
  security        Float    @default(0) // Sécurité
  accessibility   Float    @default(0) // Transports et accessibilité
  amenities       Float    @default(0) // Commerces, écoles, hôpitaux
  nightlife       Float    @default(0) // Vie nocturne
  internet        Float    @default(0) // Qualité connexion internet
  
  // Score global (moyenne)
  overall         Float    @default(0)
  
  // Métadonnées
  totalRatings    Int      @default(0) // Nombre total d'évaluations
  description     String?  // Description du quartier
  highlights      String[] // Points forts ["Marché moderne", "École internationale"]
  concerns        String[] // Points à considérer ["Trafic aux heures de pointe"]
  
  // Informations pratiques
  averageRent     Int?     // Loyer moyen dans le quartier (FCFA)
  transportCost   Int?     // Coût moyen transport quotidien (FCFA)
  popularFor      String[] // ["Étudiants", "Familles", "Jeunes professionnels"]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  neighborhood    Neighborhood @relation(fields: [neighborhoodId], references: [id], onDelete: Cascade)
  ratings         NeighborhoodRating[]

  @@map("neighborhood_scores")
}

// Modèle pour les évaluations communautaires
model NeighborhoodRating {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  userId            String   @db.ObjectId
  scoreId           String   @db.ObjectId
  
  // Scores individuels (1-5)
  security          Int
  accessibility     Int
  amenities         Int
  nightlife         Int
  internet          Int
  
  comment           String?
  createdAt         DateTime @default(now())

  // Relations
  score             NeighborhoodScore @relation(fields: [scoreId], references: [id], onDelete: Cascade)

  @@unique([userId, scoreId]) // Un utilisateur ne peut évaluer qu'une fois par quartier
  @@map("neighborhood_ratings")
}

// Modèle Lieu-dit
model Locality {
  id             String       @id @default(auto()) @map("_id") @db.ObjectId
  name           String
  neighborhoodId String       @db.ObjectId
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Relations
  neighborhood Neighborhood @relation(fields: [neighborhoodId], references: [id], onDelete: Cascade)
  properties   Property[]

  @@unique([name, neighborhoodId])
  @@map("localities")
}

// Modèle Propriété
model Property {
  id          String         @id @default(auto()) @map("_id") @db.ObjectId
  agentId     String         @db.ObjectId
  title       String
  description String
  type        PropertyType
  price       Int // Prix mensuel en FCFA
  deposit     Int // Caution en FCFA
  fees        Int? // Frais d'agence en FCFA
  
  // Localisation
  address      String
  cityId       String         @db.ObjectId
  neighborhoodId String       @db.ObjectId
  localityId   String?        @db.ObjectId
  latitude     Float?         // Optionnel maintenant
  longitude    Float?         // Optionnel maintenant
  
  // Caractéristiques
  bedrooms      Int
  bathrooms     Int
  area          Int // Surface en m²
  furnished     Boolean @default(false)
  airConditioned Boolean @default(false)
  parking       Boolean @default(false)
  security      Boolean @default(false)
  internet      Boolean @default(false)
  water         Boolean @default(false)
  electricity   Boolean @default(false)
  
  // Métadonnées
  images        String[] // URLs des images
  isAvailable   Boolean        @default(true)
  availableFrom DateTime?
  views         Int            @default(0)
  status        PropertyStatus @default(ACTIVE)
  isPremium     Boolean        @default(false)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  // Relations
  agent        Agent         @relation(fields: [agentId], references: [id], onDelete: Cascade)
  city         City          @relation(fields: [cityId], references: [id])
  neighborhood Neighborhood  @relation(fields: [neighborhoodId], references: [id])
  locality     Locality?     @relation(fields: [localityId], references: [id])
  favorites    Favorite[]
  reviews      Review[]
  messages     Message[]
  appointments Appointment[]

  @@map("properties")
}

// Modèle Favoris
model Favorite {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  userId     String   @db.ObjectId
  propertyId String   @db.ObjectId
  createdAt  DateTime @default(now())

  // Relations
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@unique([userId, propertyId])
  @@map("favorites")
}

// Modèle Avis
model Review {
  id         String  @id @default(auto()) @map("_id") @db.ObjectId
  userId     String  @db.ObjectId
  agentId    String  @db.ObjectId
  propertyId String? @db.ObjectId
  rating     Int // 1-5 étoiles
  comment    String? // Optionnel
  
  // Aspects détaillés
  communication      Int
  honesty           Int
  responsiveness    Int
  propertyAccuracy  Int
  
  isVerified Boolean  @default(false)
  createdAt  DateTime @default(now())

  // Relations
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  agent    Agent     @relation(fields: [agentId], references: [id], onDelete: Cascade)
  property Property? @relation(fields: [propertyId], references: [id], onDelete: SetNull)

  @@map("reviews")
}

// Modèle Messages
model Message {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  senderId   String   @db.ObjectId
  receiverId String   @db.ObjectId
  propertyId String?  @db.ObjectId
  content    String
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())

  // Relations
  sender   User      @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User      @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)
  property Property? @relation(fields: [propertyId], references: [id], onDelete: SetNull)

  @@map("messages")
}

// Modèle Recherches Sauvegardées
model SavedSearch {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  userId      String   @db.ObjectId
  name        String
  filters     Json // Stockage des critères de recherche
  resultCount Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("saved_searches")
}

// Modèle Rendez-vous
model Appointment {
  id               String            @id @default(auto()) @map("_id") @db.ObjectId
  tenantId         String            @db.ObjectId // Locataire qui demande
  agentId          String            @db.ObjectId // Agent qui valide
  propertyId       String            @db.ObjectId // Propriété concernée
  status           AppointmentStatus @default(PENDING)
  requestedDateTime DateTime         // Date/heure demandée par le locataire
  scheduledDateTime DateTime?        // Date/heure planifiée (confirmée par l'agent)
  message          String?           // Message optionnel du locataire
  agentNotes       String?           // Notes optionnelles de l'agent
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  // Relations
  tenant   User     @relation("RequestedAppointments", fields: [tenantId], references: [id], onDelete: Cascade)
  agent    Agent    @relation(fields: [agentId], references: [id], onDelete: Cascade)
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@map("appointments")
}

// Énumération pour les statuts de paiement
enum PaymentStatus {
  PENDING    // En attente
  PROCESSING // En cours de traitement
  COMPLETED  // Payé avec succès
  FAILED     // Échec
  CANCELLED  // Annulé
  REFUNDED   // Remboursé
}

// Énumération pour les méthodes de paiement
enum PaymentMethod {
  MTN_MOMO      // MTN Mobile Money
  ORANGE_MONEY  // Orange Money
  CARD          // Carte bancaire
  CASH          // Espèces (pour administration)
}

// Énumération pour les types de transaction
enum TransactionType {
  SUBSCRIPTION   // Abonnement mensuel
  BOOST          // Mise en avant de propriété
  COMMISSION     // Commission sur location
}

// Modèle Plan d'Abonnement
model SubscriptionPlanDetails {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  name              String   @unique // FREE, BASIC, PREMIUM
  displayName       String   // "Plan Gratuit", "Plan Basic", etc.
  price             Int      // Prix en FCFA
  maxProperties     Int      // Nombre max de propriétés (-1 = illimité)
  maxPhotos         Int      // Photos max par propriété
  maxBoosts         Int      // Mises en avant par mois
  hasPrioritySupport Boolean @default(false)
  hasAdvancedStats  Boolean @default(false)
  hasPremiumBadge   Boolean @default(false)
  description       String
  features          String[] // Liste des fonctionnalités
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("subscription_plans")
}

// Modèle Transaction/Paiement
model Payment {
  id                String          @id @default(auto()) @map("_id") @db.ObjectId
  userId            String          @db.ObjectId
  agentId           String?         @db.ObjectId
  
  // Détails du paiement
  amount            Int             // Montant en FCFA
  transactionType   TransactionType
  paymentMethod     PaymentMethod
  status            PaymentStatus   @default(PENDING)
  
  // Références externes (API Mobile Money)
  externalReference String?         // Référence de la transaction chez le provider
  phoneNumber       String?         // Numéro de téléphone pour Mobile Money
  
  // Métadonnées
  description       String
  metadata          Json?           // Données supplémentaires (propertyId pour boost, etc.)
  
  // Informations provider
  providerResponse  Json?           // Réponse complète du provider
  failureReason     String?         // Raison de l'échec si applicable
  
  // Dates
  paidAt            DateTime?       // Date de paiement confirmé
  expiresAt         DateTime?       // Pour les abonnements
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  // Relations
  user              User            @relation("UserPayments", fields: [userId], references: [id], onDelete: Cascade)

  @@map("payments")
}

// Modèle Abonnement Actif
model ActiveSubscription {
  id                String           @id @default(auto()) @map("_id") @db.ObjectId
  agentId           String           @unique @db.ObjectId
  plan              SubscriptionPlan
  
  // Dates
  startDate         DateTime
  endDate           DateTime
  isActive          Boolean          @default(true)
  
  // Limites utilisées
  propertiesUsed    Int              @default(0)
  boostsUsed        Int              @default(0)
  
  // Paiements liés
  lastPaymentId     String?          @db.ObjectId
  autoRenew         Boolean          @default(false)
  
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  // Relations
  agent             Agent            @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@map("active_subscriptions")
}